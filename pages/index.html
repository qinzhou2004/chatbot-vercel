<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soporte NKZN</title>
  <link rel="stylesheet" href="/styles/Home.module.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Soporte NKZN</h1>
      <p>Expertos en tecnología!</p>
    </header>

    <div class="chatWrapper">
      <div class="chatArea">
        <div id="messagesContainer" class="messagesContainer">
          <!-- 初始消息将由JS动态添加 -->
        </div>
      </div>

      <div class="inputContainer">
        <form id="chatForm" class="inputForm">
          <input
            type="text"
            id="messageInput"
            placeholder="Escribe tu mensaje aquí..."
          />
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const messagesContainer = document.getElementById('messagesContainer');
      const chatForm = document.getElementById('chatForm');
      const messageInput = document.getElementById('messageInput');
      let threadId = null;
      let isLoading = false;

      // 初始化对话线程和欢迎消息
      async function initializeThread() {
        try {
          const response = await fetch('/api/init-thread');
          const data = await response.json();
          threadId = data.threadId;
          addMessage('assistant', '¡Hola! Soy tu asistente de NKZN. ¿En qué puedo ayudarte hoy?');
        } catch (error) {
          console.error('Error initializing thread:', error);
        }
      }

      // 添加消息到聊天界面
      function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role === 'user' ? 'userMessage' : 'assistantMessage'}`;
        messageDiv.textContent = content;
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
      }

      // 显示加载指示器
      function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'typingIndicator';
        loadingDiv.innerHTML = '<span>•</span><span>•</span><span>•</span>';
        loadingDiv.id = 'typingIndicator';
        messagesContainer.appendChild(loadingDiv);
        scrollToBottom();
      }

      // 隐藏加载指示器
      function hideLoading() {
        const loadingDiv = document.getElementById('typingIndicator');
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }

      // 滚动到底部
      function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // 处理表单提交
      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message || isLoading) return;

        addMessage('user', message);
        messageInput.value = '';
        isLoading = true;
        showLoading();

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              message: message,
              threadId: threadId 
            }),
          });

          const data = await response.json();
          if (data.reply) {
            addMessage('assistant', data.reply);
          }
        } catch (error) {
          console.error('Error:', error);
          addMessage('assistant', 'Disculpa, estoy teniendo dificultades. ¿Podrías intentarlo de nuevo?');
        } finally {
          isLoading = false;
          hideLoading();
        }
      });

      // 初始化聊天
      initializeThread();
    });
  </script>
</body>
</html>